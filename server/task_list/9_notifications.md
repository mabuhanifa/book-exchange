# 9. Notifications Module

## Description of Module

This module handles generating, storing, and delivering notifications to users about important events in the application, such as new messages, transaction updates, and system announcements.

## Required Models (Mongoose schemas)

### `Notification` Model

```javascript
// Notification Schema
const notificationSchema = new mongoose.Schema(
  {
    recipient: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
      index: true,
    }, // User receiving the notification
    type: {
      type: String,
      enum: [
        "new_message",
        "exchange_request_received",
        "exchange_request_status_changed", // accepted, rejected, cancelled, completed
        "sell_transaction_initiated",
        "sell_transaction_status_changed", // accepted, rejected, cancelled, completed
        "sell_transaction_payment_status_changed", // marked paid
        "borrow_request_received",
        "borrow_request_status_changed", // accepted, rejected, cancelled, active, overdue, returned
        "new_review",
        "admin_message", // System announcements
        // ... other types
      ],
      required: true,
    },
    entityType: {
      type: String,
      enum: [
        "Message",
        "ExchangeRequest",
        "SellTransaction",
        "BorrowRequest",
        "Review",
        "User",
        "System",
      ],
    }, // Type of entity related to the notification
    entityId: { type: mongoose.Schema.Types.ObjectId }, // ID of the related entity (e.g., message ID, request ID)
    message: { type: String, required: true }, // The notification text
    isRead: { type: Boolean, default: false, index: true },
    // Optional data for deep linking or context
    data: { type: mongoose.Schema.Types.Mixed },
  },
  { timestamps: true }
);
```

## Required APIs (express routes)

- `GET /api/notifications`: Get a list of notifications for the authenticated user (with pagination and filter for read/unread).
- `GET /api/notifications/unread-count`: Get the count of unread notifications for the authenticated user.
- `PUT /api/notifications/:notificationId/mark-read`: Mark a specific notification as read.
- `PUT /api/notifications/mark-all-read`: Mark all notifications as read for the authenticated user.
- `DELETE /api/notifications/:notificationId`: Delete a specific notification.

## Business Logic Notes

- Generation: Notifications are generated by other modules (Chat, Transactions, Reviews, Admin) whenever a relevant event occurs.
- Storage: Notifications are stored in the database.
- Delivery: Notifications can be delivered via:
  - In-app notification list (pulled via API).
  - Real-time updates (using WebSockets, e.g., for unread count badge).
  - Push notifications (logic stub: integrate with a push notification service like Firebase Cloud Messaging - FCM).
- Content: The `message` field contains the user-facing text. `entityType` and `entityId` allow the frontend to link to the relevant item (e.g., open the chat, view the transaction).
- Read status: Users can mark notifications as read individually or all at once.

## Validation & Security Considerations

- Authentication: User must be authenticated to access their notifications.
- Authorization: Ensure users can only access, mark as read, or delete their own notifications.
- Input validation: Validate notification ID format.
- Data privacy: Notification content should not expose sensitive information about other users unless they are direct participants in the related event.

## Example Edge Cases

- A related entity (e.g., a book or transaction) is deleted, but a notification referencing it still exists.
- High volume of notifications for a user (pagination is key).
- Push notification service is down.
- User receives a notification for an event that occurred just before they were suspended.

## Database Relationships

- `Notification` has a many-to-one relationship with `Recipient` (`User`).
- `Notification` may reference other models (`Message`, `ExchangeRequest`, `SellTransaction`, `BorrowRequest`, `Review`, `User`) via `entityId` and `entityType`.
