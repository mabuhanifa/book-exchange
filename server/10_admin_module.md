# 10. Admin Module

## Description of Module

This module provides administrative functionalities for managing users, viewing system activity, resolving disputes, and potentially accessing system logs and reports. Access is restricted to users with the 'admin' role.

## Required Models (Mongoose schemas)

(This module primarily interacts with existing models: `User`, `Book`, `ExchangeRequest`, `SellTransaction`, `BorrowRequest`, `Review`, `Notification`, `Conversation`, `Message`)

### `Dispute` Model (Optional, could be a status on transaction models)

```javascript
// Dispute Schema (If separate collection is preferred)
const disputeSchema = new mongoose.Schema(
  {
    transaction: {
      // Link to the disputed transaction
      type: mongoose.Schema.Types.ObjectId,
      ref: "ExchangeRequest" || "SellTransaction" || "BorrowRequest",
      required: true,
      unique: true, // One dispute per transaction
    },
    transactionModel: {
      type: String,
      required: true,
      enum: ["ExchangeRequest", "SellTransaction", "BorrowRequest"],
    },
    raisedBy: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    }, // User who raised the dispute
    participants: [
      { type: mongoose.Schema.Types.ObjectId, ref: "User", required: true },
    ], // Users involved in the dispute
    reason: { type: String, required: true, maxlength: 1000 },
    status: {
      type: String,
      enum: ["open", "in_progress", "resolved", "closed"],
      default: "open",
    },
    resolution: { type: String, maxlength: 1000 }, // Admin's resolution notes
    resolvedBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" }, // Admin user ID
    resolvedAt: { type: Date },
  },
  { timestamps: true }
);
```

_(Alternatively, add `disputeStatus`, `disputeReason`, `resolution`, `resolvedBy`, `resolvedAt` fields directly to transaction models)_

## Required APIs (express routes)

- `GET /api/admin/dashboard-stats`: Get aggregate system statistics (e.g., total users, active listings, pending disputes).
- `GET /api/admin/users`: Get a list of all users (with filters, search, pagination).
- `GET /api/admin/users/:userId`: Get full details of a specific user (including private info if necessary for admin).
- `PUT /api/admin/users/:userId/suspend`: Suspend a user.
- `PUT /api/admin/users/:userId/restore`: Restore a user.
- `GET /api/admin/books`: Get a list of all book listings (with filters, search, pagination).
- `DELETE /api/admin/books/:bookId`: Delete a book listing (e.g., if inappropriate).
- `GET /api/admin/transactions`: Get a list of all transactions (exchange, sell, borrow - with filters, pagination).
- `GET /api/admin/disputes`: Get a list of all disputes (with filters, pagination).
- `GET /api/admin/disputes/:disputeId`: Get details of a specific dispute.
- `PUT /api/admin/disputes/:disputeId/resolve`: Resolve a dispute.
- `GET /api/admin/reviews`: Get a list of all reviews (with filters, pagination).
- `PUT /api/admin/reviews/:reviewId/moderate`: Moderate a review.
- `GET /api/admin/logs`: Get system logs (basic structure, might involve reading log files or a logging service).
- `GET /api/admin/reports/:reportType`: Generate basic reports (e.g., user growth, transaction volume per area).

## Business Logic Notes

- Access Control: All admin APIs must be protected by middleware that verifies the user has the 'admin' role.
- User Management: Admins can view all user data, suspend users (preventing them from using key features), and restore them. Suspension should update the `isSuspended` flag on the `User` model.
- Dispute Resolution: Users can flag a transaction as disputed (API not explicitly listed, could be a PUT on transaction or POST to `/api/disputes`). Admins view disputes, investigate (potentially viewing chat logs - requires careful access control), and mark them as resolved, adding notes on the resolution. Resolving a dispute might involve manually changing transaction/book/user status.
- Content Moderation: Admins can view all book listings and reviews and take action (delete listing, moderate review) if they violate community guidelines.
- Reporting: Basic reports can be generated by querying the database (e.g., count users by area, count transactions by type/status).

## Validation & Security Considerations

- Authorization: **Crucially**, implement robust role-based access control middleware to ensure _only_ users with the 'admin' role can access `/api/admin/*` endpoints.
- Authentication: Admins must be authenticated using JWT.
- Input validation: Validate input for suspension reasons, dispute resolutions, etc.
- Data Access: Admins have access to potentially sensitive user and transaction data. Ensure this access is logged and audited.
- Logging: Implement comprehensive logging for all admin actions (who did what, when).
- Rate Limiting: Apply rate limiting to admin login attempts.

## Example Edge Cases

- A non-admin user attempts to access an admin endpoint.
- Admin tries to suspend a user that doesn't exist.
- Admin tries to resolve a dispute that is already resolved or doesn't exist.
- Performance issues when fetching large lists of users, books, or transactions (pagination is essential).
- Admin actions (like suspending a user or deleting a book) need to correctly update related data (e.g., mark user's books as unavailable, cancel pending transactions).

## Database Relationships

- Admin module APIs interact with most other models (`User`, `Book`, `ExchangeRequest`, `SellTransaction`, `BorrowRequest`, `Review`, `Notification`, `Conversation`, `Message`).
- `User` model has `isSuspended`, `suspendedBy` fields related to admin actions.
- `Review` model has `isModerated`, `moderatedBy` fields related to admin actions.
- `Dispute` model (if used) links to transaction models and `User` (raisedBy, participants, resolvedBy).
